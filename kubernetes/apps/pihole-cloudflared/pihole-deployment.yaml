---
apiVersion: v1
kind: Namespace
metadata:
  name: dns
  labels:
    name: dns

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pihole-config
  namespace: dns
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: vsphere-thin
  resources:
    requests:
      storage: 2Gi

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: pihole-config
  namespace: dns
data:
  TZ: "Europe/Rome"
  WEBPASSWORD: "changeme123"  # Change this!
  PIHOLE_DNS_: "127.0.0.1#5053"  # Use cloudflared as upstream
  DNSSEC: "false"  # Cloudflared handles DNSSEC
  DNS_BOGUS_PRIV: "true"
  DNS_FQDN_REQUIRED: "true"
  DNSMASQ_LISTENING: "all"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pihole
  namespace: dns
  labels:
    app: pihole
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: pihole
  template:
    metadata:
      labels:
        app: pihole
    spec:
      containers:
        - name: pihole
          image: pihole/pihole:latest
          ports:
            - containerPort: 80
              name: http
              protocol: TCP
            - containerPort: 53
              name: dns-tcp
              protocol: TCP
            - containerPort: 53
              name: dns-udp
              protocol: UDP
          envFrom:
            - configMapRef:
                name: pihole-config
          volumeMounts:
            - name: config
              mountPath: /etc/pihole
            - name: dnsmasq
              mountPath: /etc/dnsmasq.d
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /admin/
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /admin/
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 10

        # Cloudflared sidecar for DNS-over-HTTPS
        - name: cloudflared
          image: cloudflare/cloudflared:latest
          args:
            - proxy-dns
            - --port=5053
            - --upstream=https://1.1.1.1/dns-query
            - --upstream=https://1.0.0.1/dns-query
          ports:
            - containerPort: 5053
              name: dns-https
              protocol: UDP
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - dig @127.0.0.1 -p 5053 cloudflare.com +short
            initialDelaySeconds: 30
            periodSeconds: 30

      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: pihole-config
        - name: dnsmasq
          emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: pihole-web
  namespace: dns
spec:
  selector:
    app: pihole
  ports:
    - port: 80
      targetPort: 80
      name: http

---
# DNS service with MetalLB LoadBalancer
apiVersion: v1
kind: Service
metadata:
  name: pihole-dns-tcp
  namespace: dns
  annotations:
    metallb.universe.tf/address-pool: homelab-pool
spec:
  type: LoadBalancer
  loadBalancerIP: 192.168.1.53  # Fixed IP for DNS (update for your network)
  externalTrafficPolicy: Local
  selector:
    app: pihole
  ports:
    - port: 53
      targetPort: 53
      protocol: TCP
      name: dns-tcp

---
apiVersion: v1
kind: Service
metadata:
  name: pihole-dns-udp
  namespace: dns
  annotations:
    metallb.universe.tf/address-pool: homelab-pool
    metallb.universe.tf/allow-shared-ip: "pihole-dns"  # Share IP with TCP service
spec:
  type: LoadBalancer
  loadBalancerIP: 192.168.1.53
  externalTrafficPolicy: Local
  selector:
    app: pihole
  ports:
    - port: 53
      targetPort: 53
      protocol: UDP
      name: dns-udp

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: pihole
  namespace: dns
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - pihole.homelab.local
      secretName: pihole-tls
  rules:
    - host: pihole.homelab.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: pihole-web
                port:
                  number: 80
