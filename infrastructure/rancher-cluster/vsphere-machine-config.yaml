# Machine Config per vSphere
# Definisce le configurazioni VM per i diversi pool di nodi
#
# Reti K8s:
#   - net-k8s-management (VLAN 35): Control plane, API, comunicazione nodi
#   - net-k8s-workload (VLAN 36): Pod traffic, workload
#   - net-k8s-services (VLAN 37): LoadBalancer, Ingress
#
# Template VM (importati via scripts/import-vm-templates.sh):
#   - flatcar-stable-<version>: Flatcar Container Linux per worker standard
#   - ubuntu-24.04-lts-cloudimg: Ubuntu Server per control plane e GPU workers

---
# Control Plane - Ubuntu 24.04 LTS
apiVersion: rke-machine-config.cattle.io/v1
kind: VmwarevsphereConfig
metadata:
  name: homelab-control-plane
  namespace: fleet-default
# vSphere connection
vcenter: srv02.mosca.lan
vcenterPort: "443"

# VM placement
datacenter: /DATACENTER01
datastore: datastore02-local-raid
folder: /DATACENTER01/vm/Kubernetes VMs/k8s-data-plane
pool: /DATACENTER01/host/CLUSTER01/Resources

# Network - Control Plane su management network
network:
  - /DATACENTER01/network/net-k8s-management

# VM template - Ubuntu 24.04 LTS dalla Content Library
contentLibrary: cnt-lbr-k8s-esxi01
cloneFrom: ubuntu-24.04-lts-cloudimg
creationType: library

# VM resources - Control Plane
cpuCount: "4"
memorySize: "8192"
diskSize: "50000"

# Cloud-init
cloudConfig: |
  #cloud-config
  package_update: true
  
  # Disabilita IPv6 permanentemente via sysctl.d
  write_files:
    - path: /etc/sysctl.d/99-disable-ipv6.conf
      content: |
        net.ipv6.conf.all.disable_ipv6 = 1
        net.ipv6.conf.default.disable_ipv6 = 1
        net.ipv6.conf.lo.disable_ipv6 = 1
  
  runcmd:
    - sysctl -p /etc/sysctl.d/99-disable-ipv6.conf
  
  packages:
    - curl
    - open-iscsi
    - nfs-common

---
# Worker Standard - Ubuntu 24.04 LTS
apiVersion: rke-machine-config.cattle.io/v1
kind: VmwarevsphereConfig
metadata:
  name: homelab-worker-ubuntu
  namespace: fleet-default
# vSphere connection
vcenter: srv02.mosca.lan
vcenterPort: "443"

# VM placement
datacenter: /DATACENTER01
datastore: datastore02-local-raid
folder: /DATACENTER01/vm/Kubernetes VMs/k8s-workers
pool: /DATACENTER01/host/CLUSTER01/Resources

# Network - Dual NIC:
#   NIC1 (ens160): net-k8s-workload (VLAN 36) - DHCP attivo, default route
#   NIC2 (ens192): net-k8s-services (VLAN 37) - NO DHCP (MetalLB LoadBalancer IPs)
network:
  - /DATACENTER01/network/net-k8s-workload
  - /DATACENTER01/network/net-k8s-services

# VM template - Ubuntu 24.04 LTS dalla Content Library
contentLibrary: cnt-lbr-k8s-esxi01
cloneFrom: ubuntu-24.04-lts-cloudimg
creationType: library

# VM resources - Worker
cpuCount: "4"
memorySize: "8192"
diskSize: "80000"

# Cloud-init config per Ubuntu
cloudConfig: |
  #cloud-config
  # Aggiornamento completo al primo boot
  package_update: true
  package_upgrade: true
  package_reboot_if_required: true
  
  packages:
    - open-iscsi
    - nfs-common
  
  # Script per aggiornamenti automatici periodici
  write_files:
    # Disabilita IPv6 permanentemente
    - path: /etc/sysctl.d/99-disable-ipv6.conf
      content: |
        net.ipv6.conf.all.disable_ipv6 = 1
        net.ipv6.conf.default.disable_ipv6 = 1
        net.ipv6.conf.lo.disable_ipv6 = 1
    
    # Configura esplicitamente entrambe le NIC
    - path: /etc/netplan/99-k8s-network.yaml
      content: |
        network:
          version: 2
          ethernets:
            # NIC1 workload - DHCP con default route
            ens160:
              dhcp4: true
              dhcp6: false
            # NIC2 services - NO DHCP, configurata da MetalLB
            ens192:
              dhcp4: false
              dhcp6: false
              optional: true
    
    - path: /etc/systemd/system/auto-update.service
      permissions: '0644'
      content: |
        [Unit]
        Description=Automatic system updates
        After=network-online.target
        
        [Service]
        Type=oneshot
        ExecStart=/usr/bin/apt-get update
        ExecStart=/usr/bin/apt-get -y upgrade
        # Reboot rimosso: drain manuale tramite Rancher per evitare impatti su workload
        
    - path: /etc/systemd/system/auto-update.timer
      permissions: '0644'
      content: |
        [Unit]
        Description=Weekly automatic system updates
        
        [Timer]
        OnCalendar=weekly
        RandomizedDelaySec=1h
        Persistent=true
        
        [Install]
        WantedBy=timers.target
  
  runcmd:
    # Applica sysctl per disabilitare IPv6
    - sysctl -p /etc/sysctl.d/99-disable-ipv6.conf
    # Applica configurazione rete
    - netplan apply
    # Abilita servizi storage
    - systemctl enable --now iscsid
    - systemctl enable --now nfs-common
    # Abilita aggiornamenti automatici settimanali
    - systemctl daemon-reload
    - systemctl enable --now auto-update.timer

---
# Worker GPU - Ubuntu 24.04 LTS con NVIDIA
apiVersion: rke-machine-config.cattle.io/v1
kind: VmwarevsphereConfig
metadata:
  name: homelab-worker-gpu
  namespace: fleet-default
# vSphere connection
vcenter: srv02.mosca.lan
vcenterPort: "443"

# VM placement
datacenter: /DATACENTER01
datastore: datastore02-local-raid
folder: /DATACENTER01/vm/Kubernetes VMs/k8s-workers
pool: /DATACENTER01/host/CLUSTER01/Resources

# Network - Dual NIC (stesso setup dei worker standard)
network:
  - /DATACENTER01/network/net-k8s-workload
  - /DATACENTER01/network/net-k8s-services

# VM template - Ubuntu 24.04 LTS dalla Content Library
contentLibrary: cnt-lbr-k8s-esxi01
cloneFrom: ubuntu-24.04-lts-cloudimg
creationType: library

# VM resources - GPU Worker (stesse risorse dei worker standard)
cpuCount: "4"
memorySize: "8192"
diskSize: "80000"

# Cloud-init con NVIDIA driver setup
cloudConfig: |
  #cloud-config
  package_update: true
  package_upgrade: true
  
  # Disabilita IPv6 per evitare problemi con VMware Tools e DHCP
  bootcmd:
    - echo "net.ipv6.conf.all.disable_ipv6 = 1" >> /etc/sysctl.conf
    - echo "net.ipv6.conf.default.disable_ipv6 = 1" >> /etc/sysctl.conf
    - sysctl -p
  
  packages:
    - curl
    - gnupg
    - ca-certificates
    - open-iscsi
    - nfs-common

  # Configura seconda NIC per VLAN 37 (services)
  write_files:
    - path: /etc/netplan/60-k8s-services.yaml
      content: |
        network:
          version: 2
          ethernets:
            # NIC1 workload - DHCP con default route
            ens160:
              dhcp4: true
              dhcp6: false
            # NIC2 services - DHCP ma senza route/DNS (per MetalLB)
            ens192:
              dhcp4: true
              dhcp6: false
              dhcp4-overrides:
                use-routes: false
                use-dns: false

    - path: /usr/local/bin/configure-nvidia-containerd.sh
      permissions: '0755'
      content: |
        #!/bin/bash
        set -e
        until [ -f /var/lib/rancher/rke2/agent/etc/containerd/config.toml ]; do
          sleep 10
        done
        nvidia-ctk runtime configure --runtime=containerd \
          --config=/var/lib/rancher/rke2/agent/etc/containerd/config.toml
        systemctl restart rke2-agent || true

    - path: /etc/systemd/system/nvidia-containerd-config.service
      content: |
        [Unit]
        Description=Configure NVIDIA runtime for RKE2 containerd
        After=rke2-agent.service
        Wants=rke2-agent.service

        [Service]
        Type=oneshot
        ExecStart=/usr/local/bin/configure-nvidia-containerd.sh
        RemainAfterExit=yes

        [Install]
        WantedBy=multi-user.target

  runcmd:
    # Applica sysctl per disabilitare IPv6
    - sysctl -p /etc/sysctl.d/99-disable-ipv6.conf
    # Applica netplan per seconda NIC
    - netplan apply

    # Installa NVIDIA Driver se GPU presente
    - |
      if lspci | grep -i nvidia; then
        echo "NVIDIA GPU detected, installing drivers..."
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y \
          nvidia-driver-550-server \
          nvidia-utils-550-server

        # NVIDIA Container Toolkit
        curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | \
          gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
        curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
          sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
          tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
        apt-get update
        apt-get install -y nvidia-container-toolkit

        # Abilita servizio per configurare containerd dopo RKE2
        systemctl daemon-reload
        systemctl enable nvidia-containerd-config.service
      fi
