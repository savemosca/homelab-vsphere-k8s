# Machine Config per vSphere
# Definisce le configurazioni VM per i diversi pool di nodi
#
# Reti K8s:
#   - net-k8s-management (VLAN 35): Control plane, API, comunicazione nodi
#   - net-k8s-workload (VLAN 36): Pod traffic, workload
#   - net-k8s-services (VLAN 37): LoadBalancer, Ingress

---
# Control Plane - Ubuntu 24.04
apiVersion: rke-machine-config.cattle.io/v1
kind: VmwarevsphereConfig
metadata:
  name: homelab-control-plane
  namespace: fleet-default
spec:
  # vSphere connection
  vcenter: srv02.mosca.lan
  vcenterPort: "443"

  # VM placement
  datacenter: /DATACENTER01
  datastore: /DATACENTER01/datastore/datastore02-local-raid
  folder: /DATACENTER01/vm/Kubernetes VMs
  pool: /DATACENTER01/host/CLUSTER01/Resources

  # Network - Control Plane su management network
  network:
    - /DATACENTER01/network/net-k8s-management

  # VM template - Ubuntu 24.04 dalla Content Library
  contentLibrary: cnt-lbr-esxi01
  cloneFrom: noble-server-cloudimg-amd64
  creationType: library

  # VM resources - Control Plane
  cpuCount: "4"
  memorySize: "8192"
  diskSize: "50000"

  # Cloud-init
  cloudConfig: |
    #cloud-config
    package_update: true
    packages:
      - curl
      - open-iscsi
      - nfs-common

---
# Worker Standard - Ubuntu 24.04 (in attesa di Flatcar)
apiVersion: rke-machine-config.cattle.io/v1
kind: VmwarevsphereConfig
metadata:
  name: homelab-worker-standard
  namespace: fleet-default
spec:
  # vSphere connection
  vcenter: srv02.mosca.lan
  vcenterPort: "443"

  # VM placement
  datacenter: /DATACENTER01
  datastore: /DATACENTER01/datastore/datastore02-local-raid
  folder: /DATACENTER01/vm/Kubernetes VMs
  pool: /DATACENTER01/host/CLUSTER01/Resources

  # Network - Dual NIC:
  #   NIC1: net-k8s-workload (VLAN 36) - Pod traffic, node communication
  #   NIC2: net-k8s-services (VLAN 37) - MetalLB LoadBalancer IPs
  network:
    - /DATACENTER01/network/net-k8s-workload
    - /DATACENTER01/network/net-k8s-services

  # VM template - Ubuntu 24.04
  contentLibrary: cnt-lbr-esxi01
  cloneFrom: noble-server-cloudimg-amd64
  creationType: library

  # VM resources - Worker
  cpuCount: "4"
  memorySize: "8192"
  diskSize: "80000"

  # Cloud-init per worker standard
  cloudConfig: |
    #cloud-config
    package_update: true
    packages:
      - curl
      - open-iscsi
      - nfs-common

    # Configura seconda NIC per VLAN 37 (services)
    write_files:
      - path: /etc/netplan/60-k8s-services.yaml
        content: |
          network:
            version: 2
            ethernets:
              ens192:
                dhcp4: true
                dhcp4-overrides:
                  use-routes: false
                  use-dns: false

    runcmd:
      - netplan apply

---
# Worker GPU - Ubuntu 24.04 con NVIDIA setup
apiVersion: rke-machine-config.cattle.io/v1
kind: VmwarevsphereConfig
metadata:
  name: homelab-worker-gpu
  namespace: fleet-default
spec:
  # vSphere connection
  vcenter: srv02.mosca.lan
  vcenterPort: "443"

  # VM placement
  datacenter: /DATACENTER01
  datastore: /DATACENTER01/datastore/datastore02-local-raid
  folder: /DATACENTER01/vm/Kubernetes VMs
  pool: /DATACENTER01/host/CLUSTER01/Resources

  # Network - Dual NIC (come worker standard)
  network:
    - /DATACENTER01/network/net-k8s-workload
    - /DATACENTER01/network/net-k8s-services

  # VM template - Ubuntu 24.04
  contentLibrary: cnt-lbr-esxi01
  cloneFrom: noble-server-cloudimg-amd64
  creationType: library

  # VM resources - GPU Worker (piÃ¹ risorse)
  cpuCount: "8"
  memorySize: "32768"
  diskSize: "100000"

  # Cloud-init con NVIDIA driver setup
  cloudConfig: |
    #cloud-config
    package_update: true
    package_upgrade: true
    packages:
      - curl
      - gnupg
      - ca-certificates
      - open-iscsi
      - nfs-common

    runcmd:
      # Installa NVIDIA Driver se GPU presente
      - |
        if lspci | grep -i nvidia; then
          echo "NVIDIA GPU detected, installing drivers..."
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            nvidia-driver-550-server \
            nvidia-utils-550-server

          # NVIDIA Container Toolkit
          curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | \
            gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
          curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
            sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
            tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
          apt-get update
          apt-get install -y nvidia-container-toolkit

          # Crea script per configurare containerd dopo RKE2
          cat > /usr/local/bin/configure-nvidia-containerd.sh << 'SCRIPT'
    #!/bin/bash
    set -e
    until [ -f /var/lib/rancher/rke2/agent/etc/containerd/config.toml ]; do
      sleep 10
    done
    nvidia-ctk runtime configure --runtime=containerd \
      --config=/var/lib/rancher/rke2/agent/etc/containerd/config.toml
    systemctl restart rke2-agent || true
    SCRIPT
          chmod +x /usr/local/bin/configure-nvidia-containerd.sh

          # Crea systemd service
          cat > /etc/systemd/system/nvidia-containerd-config.service << 'SERVICE'
    [Unit]
    Description=Configure NVIDIA runtime for RKE2 containerd
    After=rke2-agent.service
    Wants=rke2-agent.service

    [Service]
    Type=oneshot
    ExecStart=/usr/local/bin/configure-nvidia-containerd.sh
    RemainAfterExit=yes

    [Install]
    WantedBy=multi-user.target
    SERVICE

          systemctl daemon-reload
          systemctl enable nvidia-containerd-config.service
        fi
