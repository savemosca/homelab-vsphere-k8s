#cloud-config
# Cloud-init per Worker Node con NVIDIA GPU
# Da usare come user-data nel template vSphere

package_update: true
package_upgrade: true

packages:
  - curl
  - gnupg
  - ca-certificates

runcmd:
  # Installa NVIDIA Driver
  - |
    if lspci | grep -i nvidia; then
      echo "NVIDIA GPU detected, installing drivers..."

      # Ubuntu
      if [ -f /etc/debian_version ]; then
        apt-get update
        apt-get install -y nvidia-driver-535-server nvidia-utils-535-server
      fi

      # RHEL/Rocky
      if [ -f /etc/redhat-release ]; then
        dnf install -y epel-release
        dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel9/x86_64/cuda-rhel9.repo
        dnf install -y nvidia-driver-535
      fi

      # Installa NVIDIA Container Toolkit
      curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
      curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
        sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
        tee /etc/apt/sources.list.d/nvidia-container-toolkit.list

      apt-get update
      apt-get install -y nvidia-container-toolkit

      # Configura containerd per NVIDIA
      nvidia-ctk runtime configure --runtime=containerd
      systemctl restart containerd

      echo "NVIDIA setup completed"
    else
      echo "No NVIDIA GPU detected, skipping driver installation"
    fi

# Aggiungi label automaticamente al nodo (richiede kubectl configurato)
write_files:
  - path: /etc/systemd/system/nvidia-node-label.service
    content: |
      [Unit]
      Description=Label node with nvidia.com/gpu if GPU present
      After=kubelet.service
      Requires=kubelet.service

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/nvidia-label-node.sh
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target

  - path: /usr/local/bin/nvidia-label-node.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      # Aspetta che il nodo sia registrato
      sleep 60

      if nvidia-smi &>/dev/null; then
        NODE_NAME=$(hostname)

        # Aspetta kubeconfig
        until [ -f /etc/rancher/rke2/rke2.yaml ]; do
          sleep 10
        done

        export KUBECONFIG=/etc/rancher/rke2/rke2.yaml

        # Applica label
        kubectl label node "$NODE_NAME" nvidia.com/gpu=present --overwrite

        echo "Node labeled with nvidia.com/gpu=present"
      fi
