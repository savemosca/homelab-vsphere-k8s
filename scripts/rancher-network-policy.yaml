---
# Network Policy to restrict access to Rancher pods
# Only allows ingress traffic from Traefik (kube-system namespace)
# This is critical when using tls=external as Rancher uses HTTP internally
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rancher-access-control
  namespace: cattle-system
spec:
  podSelector:
    matchLabels:
      app: rancher
  policyTypes:
  - Ingress
  ingress:
  # Allow traffic from Traefik ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          app.kubernetes.io/name: traefik
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 444
  # Allow traffic from same namespace (for webhooks, internal communication)
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 444
