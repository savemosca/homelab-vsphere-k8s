# Rancher on K3s Installation - SRV22

Remote installation scripts for Rancher on K3s for SRV22 server. These scripts run from your macOS workstation and execute commands via SSH.

## Versions

| Component | Version |
|-----------|---------|
| K3s | v1.34.6+k3s1 (Kubernetes 1.34.6) |
| Rancher | v2.13.1 |
| cert-manager | v1.19.2 |
| Helm | v4.1.0 |

**Note**: K3s v1.34.6 is used for compatibility with Rancher 2.13.1 (requires Kubernetes < 1.35.0).

## Prerequisites

### macOS Workstation
- `sshpass` installed: `brew install sshpass`
- SSH access to target server
- Network connectivity to SRV22

### Target Server (SRV22)
- RHEL 10 (RHEL 9+ supported)
- 2 CPU cores minimum (4 recommended for production)
- 8GB RAM
- 40GB OS disk
- **50GB separate data disk** for K3s/Rancher (100GB recommended for heavy usage)
- Internet connectivity for package downloads

### Network
- FQDN configured (e.g., `srv22.mosca.lan`)
- DNS record for Rancher (e.g., `rancher.savemosca.com` → SRV22 IP)
- Required ports (handled by script if firewalld active):
  - 6443/tcp - Kubernetes API
  - 10250/tcp - Kubelet
  - 80/tcp, 443/tcp - Rancher UI

## Installation Steps

### Step 1: Identify Data Disk

SSH to the server to identify the data disk:

```bash
ssh administrator@srv22.mosca.lan
lsblk -d

# Example output:
# NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
# sda      8:0    0   80G  0 disk            <- OS disk
# sdb      8:16   0   50G  0 disk            <- Data disk for K3s
```

### Step 2: Prepare Data Disk

**WARNING**: This will erase ALL data on the specified disk!

Run from your Mac:

```bash
cd /Users/moscardini.s/Develope/homelab-vsphere-k8s/scripts

# Prepare disk (example: /dev/sdb with 50GB minimum)
./prepare-data-disk.sh srv22.mosca.lan administrator 'Netribe$1' /dev/sdb 50
```

The script will:
1. Verify disk exists and meets size requirements
2. Create GPT partition
3. Format with XFS filesystem
4. Mount to `/mnt/k3s`
5. Add entry to `/etc/fstab` for automatic mounting
6. Configure permissions

### Step 3: Install K3s and Rancher

Run from your Mac:

```bash
cd /Users/moscardini.s/Develope/homelab-vsphere-k8s/scripts

# Install with default hostname (rancher.savemosca.com)
./install-rancher-k3s.sh srv22.mosca.lan administrator 'Netribe$1'

# Or specify custom hostname
./install-rancher-k3s.sh srv22.mosca.lan administrator 'Netribe$1' rancher.savemosca.com
```

Installation includes:
1. **Dependencies** (curl, wget, jq, container-selinux, etc.)
2. **K3s v1.34.6+k3s1** (Kubernetes 1.34.6) with data dir on `/mnt/k3s`
3. **Helm v4.1.0**
4. **cert-manager v1.19.2**
5. **Rancher v2.13.1**

**Duration**: ~5-10 minutes

### Step 4: Access Rancher

The script will display access information:

```
==================================================
RANCHER ACCESS INFORMATION
==================================================
URL:      https://rancher.savemosca.com
Username: admin
Password: <auto-generated-password>

Password also saved in: /root/.rancher-bootstrap-password
==================================================
```

Access Rancher:

```bash
# Retrieve password if needed
ssh administrator@srv22.mosca.lan "sudo cat /root/.rancher-bootstrap-password"

# Open in browser
open https://rancher.savemosca.com
```

## Post-Installation Management

### Useful Commands

Run on the server via SSH:

```bash
# K3s status
systemctl status k3s
journalctl -u k3s -f

# Cluster status
k3s kubectl get nodes
k3s kubectl get pods -A

# Rancher logs
k3s kubectl logs -n cattle-system -l app=rancher -f

# cert-manager status
k3s kubectl get pods -n cert-manager

# Data disk space
df -h /mnt/k3s
du -sh /mnt/k3s/*
```

### kubectl Access for Non-Root Users

The installation script creates a `k3s-access` group:

```bash
# On server: add user to group
sudo usermod -a -G k3s-access administrator

# User adds to their .bashrc
echo 'export KUBECONFIG=/etc/rancher/k3s-access/kubeconfig' >> ~/.bashrc
source ~/.bashrc

# Now can use kubectl directly
kubectl get nodes
```

### Backup

Scripts automatically backup existing installations before proceeding.

Manual backup of `/mnt/k3s`:

```bash
# Full backup
sudo tar -czf /root/k3s-backup-$(date +%Y%m%d).tar.gz -C /mnt/k3s .

# K3s database backup
sudo cp /mnt/k3s/server/db/state.db /root/k3s-state-backup-$(date +%Y%m%d).db
```

## Troubleshooting

### Rancher Not Accessible

```bash
# Check Rancher pods
ssh administrator@srv22.mosca.lan "sudo k3s kubectl get pods -n cattle-system"

# Check DNS
nslookup rancher.mosca.lan

# Check firewall
ssh administrator@srv22.mosca.lan "sudo firewall-cmd --list-all"

# Rancher logs
ssh administrator@srv22.mosca.lan "sudo k3s kubectl logs -n cattle-system -l app=rancher"
```

### K3s Not Starting After Reboot

```bash
# Check mount
ssh administrator@srv22.mosca.lan "mount | grep /mnt/k3s"

# Manual mount if needed
ssh administrator@srv22.mosca.lan "sudo mount /mnt/k3s"

# Restart K3s
ssh administrator@srv22.mosca.lan "sudo systemctl restart k3s"
```

### Disk Full

```bash
# Check space
ssh administrator@srv22.mosca.lan "df -h /mnt/k3s"

# Identify usage
ssh administrator@srv22.mosca.lan "sudo du -sh /mnt/k3s/*"

# Clean unused images
ssh administrator@srv22.mosca.lan "sudo k3s crictl rmi --prune"

# Delete failed/completed pods
ssh administrator@srv22.mosca.lan "sudo k3s kubectl delete pods --field-selector=status.phase=Failed -A"
ssh administrator@srv22.mosca.lan "sudo k3s kubectl delete pods --field-selector=status.phase=Succeeded -A"
```

### SELinux Issues

```bash
# Check SELinux status
ssh administrator@srv22.mosca.lan "getenforce"

# Temporarily disable for testing
ssh administrator@srv22.mosca.lan "sudo setenforce 0"

# If it resolves issue, make permanent
ssh administrator@srv22.mosca.lan "sudo sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config"
```

### sshpass Not Installed

If you get "sshpass command not found":

```bash
# Install on macOS
brew install sshpass
```

## Script Files

- `prepare-data-disk.sh` - Prepare and mount data disk for K3s
- `install-rancher-k3s.sh` - Install K3s and Rancher
- `README-SRV22.md` - This documentation

## Execution Flow

```
macOS (your workstation)
  |
  |-- prepare-data-disk.sh (SSH to SRV22)
  |     |
  |     |-- Partition /dev/sdb
  |     |-- Format XFS
  |     |-- Mount /mnt/k3s
  |     └-- Add to /etc/fstab
  |
  └-- install-rancher-k3s.sh (SSH to SRV22)
        |
        |-- Install dependencies
        |-- Install K3s with data dir /mnt/k3s
        |-- Install Helm
        |-- Install cert-manager
        └-- Install Rancher
```

## Known Issues

### Rancher 2.13.1 CAPI Bug

Rancher 2.13.1 has a known CAPI (Cluster API) bug that prevents cluster provisioning via Rancher UI/API/CLI. Error: `"no matching controller owner ref"`

**Workaround**: Manual VM provisioning + cluster registration in Rancher (documented in main project README).

This bug is specific to provisioning via Rancher - the Rancher management plane itself works fine.

## Next Steps

1. **Configure DNS**: Point `rancher.savemosca.com` to SRV22 IP
2. **Configure vSphere credentials** in Rancher UI
3. **Create workload cluster** (homelab-k8s)
   - Due to CAPI bug, use manual provisioning approach
4. **Deploy infrastructure**: MetalLB, cert-manager, Sealed Secrets, vSphere CSI
5. **Deploy applications**: Media stack, monitoring, etc.

## Support

For issues:
1. Check logs using commands in Troubleshooting section
2. Review official documentation:
   - [K3s Docs](https://docs.k3s.io/)
   - [Rancher Docs](https://ranchermanager.docs.rancher.com/)
3. Check Rancher 2.13.1 known issues for CAPI bug details
