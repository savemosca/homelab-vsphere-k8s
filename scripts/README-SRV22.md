# Rancher on K3s Installation - SRV22

Remote installation scripts for Rancher on K3s for SRV22 server. These scripts run from your macOS workstation and execute commands via SSH.

## Versions

| Component | Version |
|-----------|---------|
| K3s | v1.34.3+k3s1 (Kubernetes 1.34.3) |
| Rancher | v2.13.1 |
| cert-manager | v1.19.2 |
| Helm | v4.1.0 |

**Note**: K3s v1.34.3 is used for compatibility with Rancher 2.13.1 (requires Kubernetes < 1.35.0).

## Prerequisites

### macOS Workstation
- SSH client (pre-installed on macOS)
- SSH key pair (e.g., `~/.ssh/id_ed25519`)
- Network connectivity to SRV22

### Target Server (SRV22)
- RHEL 10 (RHEL 9+ supported)
- 2 CPU cores minimum (4 recommended for production)
- 8GB RAM
- 40GB OS disk
- **50GB separate data disk** for K3s/Rancher (100GB recommended for heavy usage)
- Internet connectivity for package downloads

### Network
- FQDN configured (e.g., `srv22.mosca.lan`)
- DNS record for Rancher (e.g., `rancher.savemosca.com` → SRV22 IP)
- Required ports (handled by script if firewalld active):
  - 6443/tcp - Kubernetes API
  - 10250/tcp - Kubelet
  - 80/tcp, 443/tcp - Rancher UI

## Installation Steps

### Step 1: Setup SSH Key Authentication (One-time)

Configure SSH key authentication and passwordless sudo:

```bash
cd /Users/moscardini.s/Develope/homelab-vsphere-k8s/scripts

# Setup SSH key authentication (uses password once)
./setup-ssh-key.sh srv22.mosca.lan administrator 'YourPassword'

# Or specify custom SSH key
./setup-ssh-key.sh 192.168.11.130 administrator 'YourPassword' ~/.ssh/id_rsa.pub
```

The script will:

1. Copy your SSH public key to the server
2. Configure passwordless sudo for the user
3. Test both SSH key auth and passwordless sudo

After this step, all subsequent scripts will use SSH keys (no password needed).

### Step 2: Prepare Data Disk

**WARNING**: This will erase ALL data on the specified disk!

Run from your Mac:

```bash
cd /Users/moscardini.s/Develope/homelab-vsphere-k8s/scripts

# Auto-detect blank disk (recommended)
./prepare-data-disk.sh srv22.mosca.lan administrator

# Or specify disk explicitly
./prepare-data-disk.sh 192.168.11.130 administrator /dev/sdb 50
```

The script will:

1. Auto-detect blank disk ≥50GB (or use specified device)
2. Create GPT partition
3. Format with XFS filesystem
4. Mount to `/mnt/k3s`
5. Add entry to `/etc/fstab` for automatic mounting
6. Configure permissions
7. Apply SELinux context (if enforcing)

### Step 3: Install K3s and Rancher

Run from your Mac:

```bash
cd /Users/moscardini.s/Develope/homelab-vsphere-k8s/scripts

# Install with default hostname (rancher.savemosca.com)
./install-rancher-k3s.sh srv22.mosca.lan administrator

# Or specify custom hostname
./install-rancher-k3s.sh 192.168.11.130 administrator rancher.savemosca.com
```

Installation includes:

1. **Firewall configuration** (K3s ports + pod network CIDRs)
2. **SELinux context** for `/mnt/k3s` (if enforcing)
3. **Dependencies** (curl, wget, jq, container-selinux, policycoreutils-python-utils, etc.)
4. **K3s v1.34.3+k3s1** (Kubernetes 1.34.3) with data dir on `/mnt/k3s`
5. **Helm v4.1.0**
6. **cert-manager v1.19.2**
7. **Rancher v2.13.1** with `tls=external` (Traefik handles TLS)
8. **NetworkPolicy** to restrict Rancher pod access to Traefik only

**Duration**: ~5-10 minutes

### Step 4: Access Rancher

The script will display access information:

```
==================================================
RANCHER ACCESS INFORMATION
==================================================
URL:      https://rancher.savemosca.com
Username: admin
Password: <auto-generated-password>

Password also saved in: /root/.rancher-bootstrap-password
==================================================
```

Access Rancher:

```bash
# Retrieve password if needed
ssh administrator@srv22.mosca.lan "sudo cat /root/.rancher-bootstrap-password"

# Open in browser
open https://rancher.savemosca.com
```

## Post-Installation Management

### Useful Commands

Run on the server via SSH:

```bash
# K3s status
systemctl status k3s
journalctl -u k3s -f

# Cluster status
k3s kubectl get nodes
k3s kubectl get pods -A

# Rancher logs
k3s kubectl logs -n cattle-system -l app=rancher -f

# cert-manager status
k3s kubectl get pods -n cert-manager

# Data disk space
df -h /mnt/k3s
du -sh /mnt/k3s/*
```

### kubectl Access for Non-Root Users

The installation script creates a `k3s-access` group:

```bash
# On server: add user to group
sudo usermod -a -G k3s-access administrator

# User adds to their .bashrc
echo 'export KUBECONFIG=/etc/rancher/k3s-access/kubeconfig' >> ~/.bashrc
source ~/.bashrc

# Now can use kubectl directly
kubectl get nodes
```

### Backup

Scripts automatically backup existing installations before proceeding.

Manual backup of `/mnt/k3s`:

```bash
# Full backup
sudo tar -czf /root/k3s-backup-$(date +%Y%m%d).tar.gz -C /mnt/k3s .

# K3s database backup
sudo cp /mnt/k3s/server/db/state.db /root/k3s-state-backup-$(date +%Y%m%d).db
```

## Troubleshooting

### Rancher Not Accessible

```bash
# Check Rancher pods
ssh administrator@srv22.mosca.lan "sudo k3s kubectl get pods -n cattle-system"

# Check DNS
nslookup rancher.mosca.lan

# Check firewall
ssh administrator@srv22.mosca.lan "sudo firewall-cmd --list-all"

# Rancher logs
ssh administrator@srv22.mosca.lan "sudo k3s kubectl logs -n cattle-system -l app=rancher"
```

### K3s Not Starting After Reboot

```bash
# Check mount
ssh administrator@srv22.mosca.lan "mount | grep /mnt/k3s"

# Manual mount if needed
ssh administrator@srv22.mosca.lan "sudo mount /mnt/k3s"

# Restart K3s
ssh administrator@srv22.mosca.lan "sudo systemctl restart k3s"
```

### Disk Full

```bash
# Check space
ssh administrator@srv22.mosca.lan "df -h /mnt/k3s"

# Identify usage
ssh administrator@srv22.mosca.lan "sudo du -sh /mnt/k3s/*"

# Clean unused images
ssh administrator@srv22.mosca.lan "sudo k3s crictl rmi --prune"

# Delete failed/completed pods
ssh administrator@srv22.mosca.lan "sudo k3s kubectl delete pods --field-selector=status.phase=Failed -A"
ssh administrator@srv22.mosca.lan "sudo k3s kubectl delete pods --field-selector=status.phase=Succeeded -A"
```

### SELinux Issues

```bash
# Check SELinux status
ssh administrator@srv22.mosca.lan "getenforce"

# Temporarily disable for testing
ssh administrator@srv22.mosca.lan "sudo setenforce 0"

# If it resolves issue, make permanent
ssh administrator@srv22.mosca.lan "sudo sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config"
```

### sshpass Not Installed

If you get "sshpass command not found":

```bash
# Install on macOS
brew install sshpass
```

## Script Files

- `prepare-data-disk.sh` - Prepare and mount data disk for K3s
- `install-rancher-k3s.sh` - Install K3s and Rancher
- `README-SRV22.md` - This documentation

## Execution Flow

```
macOS (your workstation)
  |
  |-- prepare-data-disk.sh (SSH to SRV22)
  |     |
  |     |-- Partition /dev/sdb
  |     |-- Format XFS
  |     |-- Mount /mnt/k3s
  |     └-- Add to /etc/fstab
  |
  └-- install-rancher-k3s.sh (SSH to SRV22)
        |
        |-- Install dependencies
        |-- Install K3s with data dir /mnt/k3s
        |-- Install Helm
        |-- Install cert-manager
        └-- Install Rancher
```

## Known Issues

### Rancher 2.13.1 CAPI Bug

Rancher 2.13.1 has a known CAPI (Cluster API) bug that prevents cluster provisioning via Rancher UI/API/CLI. Error: `"no matching controller owner ref"`

**Workaround**: Manual VM provisioning + cluster registration in Rancher (documented in main project README).

This bug is specific to provisioning via Rancher - the Rancher management plane itself works fine.

## Next Steps

1. **Configure DNS**: Point `rancher.savemosca.com` to SRV22 IP
2. **Configure vSphere credentials** in Rancher UI
3. **Create workload cluster** (homelab-k8s)
   - Due to CAPI bug, use manual provisioning approach
4. **Deploy infrastructure**: MetalLB, cert-manager, Sealed Secrets, vSphere CSI
5. **Deploy applications**: Media stack, monitoring, etc.

## Support

For issues:
1. Check logs using commands in Troubleshooting section
2. Review official documentation:
   - [K3s Docs](https://docs.k3s.io/)
   - [Rancher Docs](https://ranchermanager.docs.rancher.com/)
3. Check Rancher 2.13.1 known issues for CAPI bug details
